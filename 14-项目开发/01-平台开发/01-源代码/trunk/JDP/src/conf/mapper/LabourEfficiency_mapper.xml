<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jd.pims.pem.dao.LabourEfficiencyDao">
	<!-- 人效 -->
	<resultMap id="labourEfficiency" type="com.jd.pims.pem.model.LabourEfficiency">
		<id column="id" property="id" />
		<result column="cu_id" property="cuId" />
		<result column="cu_name" property="cuName" />
		<result column="biz_date" property="bizDate" />
		<result column="time_period" property="timePeriod" />
		<result column="efficiency" property="efficiency" />
		<result column="number_onduty" property="numberOnduty" />
		<result column="order_quantity" property="orderQuantity" />
		<result column="period_efficiency" property="periodEfficiency" />
		<result column="avg_efficiency" property="avgEfficiency" />
		<result column="create_time" property="createTime" />
		<result column="last_update_time" property="lastUpdateTime" />
	</resultMap>

	<select id="getLabourEfficiency" resultMap="labourEfficiency">
	<![CDATA[
		SELECT SUM(RSS.QUANTITY_ONDUTY) AS NUMBER_ONDUTY,SUM(LE.ORDER_QUANTITY) AS ORDER_QUANTITY FROM (
			SELECT CU_ID,BIZ_DATE,SUM(QUANTITY_ONDUTY) AS QUANTITY_ONDUTY FROM (
				SELECT CU_ID,BIZ_DATE,PERSON_TYPE,AVG(QUANTITY_ONDUTY) AS QUANTITY_ONDUTY 
				FROM JD_LE_LABOUR_ONDUTY 
				WHERE BIZ_DATE=#{bizDate} AND TIMING >=#{beginTime} AND TIMING <#{endTime} and PERSON_TYPE<>'5'
				GROUP BY CU_ID,BIZ_DATE,PERSON_TYPE) RS
			GROUP BY CU_ID,BIZ_DATE) RSS
		LEFT JOIN (SELECT CU_ID,BIZ_DATE,ORDER_QUANTITY FROM JD_LE_ORDER_QUANTITY WHERE BIZ_DATE=#{bizDate} AND TIME_PERIOD=#{timePeriod}) LE 
			ON RSS.CU_ID=LE.CU_ID AND LE.BIZ_DATE = RSS.BIZ_DATE
		INNER JOIN NP_SYS_CONTROLUNIT CU ON CU.ID=RSS.CU_ID
		WHERE  CU.FULL_PATH LIKE CONCAT(#{fullPath},'%' )
	]]>
	</select>
	
	<select id="getEfficiencyOrderForChart" resultType="java.util.HashMap">
	<![CDATA[
		SELECT 		
		IFNULL(sum(qu.ORDER_QUANTITY),0) as orderNum
		FROM JD_LE_ORDER_QUANTITY qu where qu.CU_ID in(select MANAGE_ID from NP_CF_SUBSYSTEM sub LEFT JOIN NP_EQ_AREA area on sub.AREA_ID = area.ID where area.FULL_PATH like CONCAT((select FULL_PATH from NP_EQ_AREA where AREA_NAME = #{name}),'%')) and qu.BIZ_DATE = #{date}
		AND qu.TIME_PERIOD=#{timePeriod} 
	]]>
	</select>
	
	<select id="getHistoryLabourEfficiency" resultMap="labourEfficiency">
	<![CDATA[
		SELECT RSS.BIZ_DATE,SUM(RSS.QUANTITY_ONDUTY) AS NUMBER_ONDUTY,SUM(LE.ORDER_QUANTITY ) AS ORDER_QUANTITY
		FROM (
			SELECT CU_ID,BIZ_DATE,SUM(QUANTITY_ONDUTY) AS QUANTITY_ONDUTY FROM (
				SELECT CU_ID,BIZ_DATE,PERSON_TYPE,AVG(QUANTITY_ONDUTY) AS QUANTITY_ONDUTY 
				FROM JD_LE_LABOUR_ONDUTY 
				WHERE BIZ_DATE>=#{startDate} AND BIZ_DATE<=#{endDate} and PERSON_TYPE<>'5'
				GROUP BY CU_ID,BIZ_DATE,PERSON_TYPE) RS
			GROUP BY CU_ID,BIZ_DATE) RSS
 		INNER JOIN (SELECT CU_ID,BIZ_DATE,SUM(ORDER_QUANTITY) ORDER_QUANTITY 
 			FROM JD_LE_ORDER_QUANTITY WHERE BIZ_DATE>=#{startDate} AND BIZ_DATE<=#{endDate}
			GROUP BY CU_ID,BIZ_DATE) LE 
			ON RSS.CU_ID=LE.CU_ID AND LE.BIZ_DATE = RSS.BIZ_DATE
		INNER JOIN NP_SYS_CONTROLUNIT CU ON CU.ID=RSS.CU_ID
		WHERE  CU.FULL_PATH LIKE CONCAT(#{fullPath},'%' )
		GROUP BY BIZ_DATE
	]]>
	</select>
	
	
	<select id="getHistoryEfficiencyForChart" resultType="java.util.HashMap">
	<![CDATA[
		SELECT concat(concat((date_format(LE.BIZ_DATE,'%m')),'月'),concat((date_format(LE.BIZ_DATE,'%d')),'日')) as name,sum(IFNULL(LE.AVG_EFFICIENCY,0)) as effect,sum(IFNULL(ond.AVG_QUANTITY,0)) as clerkNum
		FROM JD_LE_LABOUR_EFFICIENCY LE
		LEFT JOIN JD_LE_LABOUR_ONDUTY_DAY_ST ond on ond.CU_ID=LE.CU_ID and LE.BIZ_DATE = ond.BIZ_DATE
		WHERE LE.BIZ_DATE>=#{startDate} AND LE.BIZ_DATE<#{endDate} AND ond.PERSON_TYPE != 5
		AND LE.CU_ID in(select MANAGE_ID from NP_CF_SUBSYSTEM sub LEFT JOIN NP_EQ_AREA area on sub.AREA_ID = area.ID where area.FULL_PATH like CONCAT((select FULL_PATH from NP_EQ_AREA where AREA_NAME = #{name}),'%' ))
		GROUP by LE.BIZ_DATE
	]]>
	</select>
	
	<select id="getHistoryEfficiencyOrderForChart" resultType="java.util.HashMap">
	<![CDATA[
		SELECT concat(concat((date_format(qu.BIZ_DATE,'%m')),'月'),concat((date_format(qu.BIZ_DATE,'%d')),'日')) as name,avg(IFNULL(qu.ORDER_QUANTITY,0)) as orderNum
		FROM JD_LE_ORDER_QUANTITY qu 
		WHERE qu.BIZ_DATE>=#{startDate} AND qu.BIZ_DATE<#{endDate} 
		AND qu.CU_ID in(select MANAGE_ID from NP_CF_SUBSYSTEM sub LEFT JOIN NP_EQ_AREA area on sub.AREA_ID = area.ID where area.FULL_PATH like CONCAT((select FULL_PATH from NP_EQ_AREA where AREA_NAME = #{name}),'%' ))
		GROUP by qu.BIZ_DATE
	]]>
	</select>
</mapper>  