<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jd.pims.pem.dao.LabourEfficiencyDao">
	<!-- 人效 -->
	<resultMap id="labourEfficiency" type="com.jd.pims.pem.model.LabourEfficiency">
		<id column="id" property="id" />
		<result column="cu_id" property="cuId" />
		<result column="cu_name" property="cuName" />
		<result column="biz_date" property="bizDate" />
		<result column="time_period" property="timePeriod" />
		<result column="efficiency" property="efficiency" />
		<result column="number_onduty" property="numberOnduty" />
		<result column="order_quantity" property="orderQuantity" />
		<result column="period_efficiency" property="periodEfficiency" />
		<result column="avg_efficiency" property="avgEfficiency" />
		<result column="create_time" property="createTime" />
		<result column="last_update_time" property="lastUpdateTime" />
	</resultMap>

	<select id="getLabourEfficiency" resultMap="labourEfficiency">
	<![CDATA[
		SELECT 		
			IFNULL(avg(case when LE.PERSON_TYPE='1' THEN LE.QUANTITY_ONDUTY END),0)+
			IFNULL(avg(case when LE.PERSON_TYPE='2' THEN LE.QUANTITY_ONDUTY END),0)+
		 	IFNULL(avg(case	when LE.PERSON_TYPE='3' THEN LE.QUANTITY_ONDUTY END),0)+
		    IFNULL(avg(case	when LE.PERSON_TYPE='4' THEN LE.QUANTITY_ONDUTY END),0)+
		    IFNULL(avg(case when LE.PERSON_TYPE='5' THEN LE.QUANTITY_ONDUTY END),0) 
		    	AS NUMBER_ONDUTY, SUM(QU.ORDER_QUANTITY) AS ORDER_QUANTITY
		FROM (SELECT PERSON_TYPE,QUANTITY_ONDUTY,CU_ID,BIZ_DATE FROM JD_LE_LABOUR_ONDUTY 
			WHERE BIZ_DATE=#{bizDate} AND TIMING >=#{beginTime} AND TIMING <#{endTime} 
			)  LE
		LEFT JOIN JD_LE_ORDER_QUANTITY QU ON QU.CU_ID=LE.CU_ID AND LE.BIZ_DATE = QU.BIZ_DATE
		INNER JOIN NP_SYS_CONTROLUNIT CU ON LE.CU_ID=CU.ID
		WHERE QU.TIME_PERIOD=#{timePeriod}
					AND CU.FULL_PATH LIKE CONCAT(#{fullPath},'%' )
	]]>
	</select>
	
	<select id="getEfficiencyOrderForChart" resultType="java.util.HashMap">
	<![CDATA[
		SELECT 		
		IFNULL(sum(qu.ORDER_QUANTITY),0) as orderNum
		FROM JD_LE_ORDER_QUANTITY qu where qu.CU_ID in(select MANAGE_ID from NP_CF_SUBSYSTEM sub LEFT JOIN NP_EQ_AREA area on sub.AREA_ID = area.ID where area.FULL_PATH like CONCAT((select FULL_PATH from NP_EQ_AREA where AREA_NAME = #{name}),'%')) and qu.BIZ_DATE = #{date}
		AND qu.TIME_PERIOD=#{timePeriod} 
	]]>
	</select>
	
	<select id="getHistoryLabourEfficiency" resultMap="labourEfficiency">
	<![CDATA[
		SELECT LE.ID,LE.CU_ID,CU.NAME AS CU_NAME,LE.BIZ_DATE,LE.AVG_EFFICIENCY AS EFFICIENCY,
		LAB.QUANTITY_ONDUTY AS NUMBER_ONDUTY,ORD.TOTAL_QUANTITY AS ORDER_QUANTITY
		FROM JD_LE_LABOUR_EFFICIENCY LE
		INNER JOIN NP_SYS_CONTROLUNIT CU ON LE.CU_ID=CU.ID
		LEFT OUTER JOIN 
		(SELECT CU_ID,BIZ_DATE,ROUND(AVG(QUANTITY_ONDUTY),0) AS QUANTITY_ONDUTY FROM JD_LE_LABOUR_ONDUTY
		 GROUP BY CU_ID,BIZ_DATE) LAB ON LAB.CU_ID=LE.CU_ID AND LAB.BIZ_DATE=LE.BIZ_DATE
		LEFT OUTER JOIN (SELECT CU_ID,BIZ_DATE,TOTAL_QUANTITY FROM JD_LE_ORDER_QUANTITY WHERE TIME_PERIOD=24) ORD
			ON ORD.CU_ID=LE.CU_ID AND ORD.BIZ_DATE=LE.BIZ_DATE
		WHERE LE.BIZ_DATE>=#{startDate} AND LE.BIZ_DATE<=#{endDate}  AND LE.TIME_PERIOD=24 
			AND CU.FULL_PATH LIKE CONCAT(#{fullPath},'%' )
	]]>
	</select>
	
	
	<select id="getHistoryEfficiencyForChart" resultType="java.util.HashMap">
	<![CDATA[
		SELECT concat(concat((date_format(LE.BIZ_DATE,'%m')),'月'),concat((date_format(LE.BIZ_DATE,'%d')),'日')) as name,sum(IFNULL(LE.AVG_EFFICIENCY,0)) as effect,sum(IFNULL(ond.AVG_QUANTITY,0)) as clerkNum
		FROM JD_LE_LABOUR_EFFICIENCY LE
		LEFT JOIN JD_LE_LABOUR_ONDUTY_DAY_ST ond on ond.CU_ID=LE.CU_ID and LE.BIZ_DATE = ond.BIZ_DATE
		WHERE LE.BIZ_DATE>=#{startDate} AND LE.BIZ_DATE<#{endDate} AND LE.TIME_PERIOD='24' AND ond.PERSON_TYPE != 5
		AND LE.CU_ID in(select MANAGE_ID from NP_CF_SUBSYSTEM sub LEFT JOIN NP_EQ_AREA area on sub.AREA_ID = area.ID where area.FULL_PATH like CONCAT((select FULL_PATH from NP_EQ_AREA where AREA_NAME = #{name}),'%' ))
		GROUP by LE.BIZ_DATE
	]]>
	</select>
	
	<select id="getHistoryEfficiencyOrderForChart" resultType="java.util.HashMap">
	<![CDATA[
		SELECT concat(concat((date_format(qu.BIZ_DATE,'%m')),'月'),concat((date_format(qu.BIZ_DATE,'%d')),'日')) as name,sum(IFNULL(qu.TOTAL_QUANTITY,0)) as orderNum
		FROM JD_LE_ORDER_QUANTITY qu 
		WHERE qu.BIZ_DATE>=#{startDate} AND qu.BIZ_DATE<#{endDate} AND qu.TIME_PERIOD='24'
		AND qu.CU_ID in(select MANAGE_ID from NP_CF_SUBSYSTEM sub LEFT JOIN NP_EQ_AREA area on sub.AREA_ID = area.ID where area.FULL_PATH like CONCAT((select FULL_PATH from NP_EQ_AREA where AREA_NAME = #{name}),'%' ))
		GROUP by qu.BIZ_DATE
	]]>
	</select>
</mapper>  