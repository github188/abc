<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jd.pims.pem.dao.LabourOndutyDao" >
  <!-- 在岗人数  -->
  <resultMap id="labourOnduty" type="com.jd.pims.pem.model.LabourOnduty" >
    <id column="id" property="id" />
    <result column="cu_id" property="cuId"  />
    <result column="biz_date" property="bizDate"  />
    <result column="timing" property="timing"  />
    <result column="person_type" property="personType"  />
    <result column="quantity_onduty" property="quantityOnduty"  />
    <result column="create_time" property="createTime"  />
    <result column="last_update_time" property="lastUpdateTime"  />
  </resultMap>
  
  <resultMap id="labourOndutyDayState" type="com.jd.pims.pem.model.LabourOndutyDayState" >
    <id column="id" property="id" />
    <result column="cu_id" property="cuId"  />
    <result column="biz_date" property="bizDate"  />
    <result column="person_type" property="personType"  />
    <result column="avg_quantity" property="avgQuantity"  />
    <result column="max_quantity" property="maxQuantity"  />
    <result column="min_quantity" property="minQuantity"  />
    <result column="create_time" property="createTime"  />
    <result column="last_update_time" property="lastUpdateTime"  />
  </resultMap>

  <select id="getCurrentTimeLabourOnduty" resultMap="labourOnduty">
   <![CDATA[	
  	SELECT LO.CU_ID,LO.BIZ_DATE,LO.PERSON_TYPE,IFNULL(ROUND(AVG(LO.QUANTITY_ONDUTY)),0) AS QUANTITY_ONDUTY
	FROM JD_LE_LABOUR_ONDUTY LO
		 LEFT JOIN NP_SYS_CONTROLUNIT CU ON LO.CU_ID=CU.ID
	WHERE LO.BIZ_DATE=#{currentDate} AND TIMING>=#{beginTime} AND TIMING<#{endTime}
		  		and CU.FULL_PATH like CONCAT(#{fullPath},'%' )
	GROUP BY LO.CU_ID,LO.BIZ_DATE,LO.PERSON_TYPE 	  	
	]]>	
  </select>

  <select id="getHistoryLabourOnduty" resultMap="labourOndutyDayState">
  	<![CDATA[
  	SELECT ST.ID, ST.CU_ID, ST.BIZ_DATE, ST.PERSON_TYPE, ST.AVG_QUANTITY, ST.MIN_QUANTITY, ST.MAX_QUANTITY
	FROM  JD_LE_LABOUR_ONDUTY_DAY_ST ST
	INNER JOIN NP_SYS_CONTROLUNIT CU ON ST.CU_ID=CU.ID
	WHERE BIZ_DATE>=#{startDate} AND BIZ_DATE<=#{endDate} 
		AND CU.FULL_PATH LIKE CONCAT(#{fullPath},'%' )
  	]]>
  </select>
  
  <select id="getCurrentTimeLabourOndutyForChart" resultType="java.util.HashMap">
	<![CDATA[	
		select 		
			IFNULL(round(avg(case when PERSON_TYPE='1' THEN QUANTITY_ONDUTY END),2),0) as EmpNum,
			IFNULL(round(avg(case when PERSON_TYPE='2' THEN QUANTITY_ONDUTY END),2),0)*0.8+
	 		IFNULL(round(avg(case	when PERSON_TYPE='3' THEN QUANTITY_ONDUTY END),2),0)*0.5+
	        IFNULL(round(avg(case	when PERSON_TYPE='4' THEN QUANTITY_ONDUTY END),2),0)*0.8 as NotEmpNum,
	        IFNULL(round(avg(case when PERSON_TYPE='5' THEN QUANTITY_ONDUTY END),2),0) as otherNumEmp
	        from JD_LE_LABOUR_ONDUTY 
	        WHERE BIZ_DATE=#{currentDate} 
	        AND TIMING >=#{begin} 
	        AND TIMING <#{end} 
			AND  CU_ID in(select MANAGE_ID from NP_CF_SUBSYSTEM sub LEFT JOIN NP_EQ_AREA area on sub.AREA_ID = area.ID where area.AREA_CLASS='BROUGH' and area.FULL_PATH like CONCAT((select distinct FULL_PATH from NP_EQ_AREA where AREA_NAME = #{name}),'%' ))
	]]>
  </select>
  
   <select id="getCurrentTimeLabourOndutyForChart1" resultType="java.util.HashMap">
	<![CDATA[	
		select 		
	        PERSON_TYPE as personType,IFNULL(QUANTITY_ONDUTY,0) as Num
	        from JD_LE_LABOUR_ONDUTY 
	        WHERE BIZ_DATE=#{currentDate} 
	        AND TIMING >=#{begin} 
	        AND TIMING <#{end} 
			AND  CU_ID in(select MANAGE_ID from NP_CF_SUBSYSTEM sub LEFT JOIN NP_EQ_AREA area on sub.AREA_ID = area.ID where area.AREA_CLASS='BROUGH' and area.FULL_PATH like CONCAT((select distinct FULL_PATH from NP_EQ_AREA where AREA_NAME = #{name}),'%' ))
	]]>
  </select>
  
<!--   <select id="getHistoryLabourOndutyForChart" resultType="java.util.HashMap">
	<![CDATA[	
		SELECT concat(concat((date_format(LO.BIZ_DATE,'%m')),'月'),concat((date_format(LO.BIZ_DATE,'%d')),'日')) as name,sum(case when LO.PERSON_TYPE='1' THEN LO.AVG_QUANTITY ELSE 0 END) as EmpNum,sum(case when LO.PERSON_TYPE='2' THEN LO.AVG_QUANTITY
 				 when LO.PERSON_TYPE='3' THEN LO.AVG_QUANTITY
                 when LO.PERSON_TYPE='4' THEN LO.AVG_QUANTITY ELSE 0 END) as NotEmpNum
		  	FROM JD_LE_LABOUR_ONDUTY_DAY_ST LO
		  	WHERE LO.BIZ_DATE>=#{startDate} AND LO.BIZ_DATE<#{endDate}
			AND LO.CU_ID in(select MANAGE_ID from NP_CF_SUBSYSTEM sub LEFT JOIN NP_EQ_AREA area on sub.AREA_ID = area.ID where area.AREA_CLASS='BROUGH' and area.FULL_PATH like CONCAT((select distinct FULL_PATH from NP_EQ_AREA where AREA_NAME = #{name}),'%' ))
		 GROUP BY LO.BIZ_DATE
	]]>
  </select> -->
  
    <select id="getHistoryLabourOndutyForChart" resultType="java.util.HashMap">
	<![CDATA[	
		select 
		concat(concat((date_format(door.OPEN_TIME,'%m')),'月'),concat((date_format(door.OPEN_TIME,'%d')),'日')) as name,
		sum(case when person.WORK_TYPE='1' THEN 1 ELSE 0 END) as EmpNum,
		sum(case when person.WORK_TYPE='2' THEN 0.8
		 		 when person.WORK_TYPE='3' THEN 0.5
		         when person.WORK_TYPE='4' THEN 0.8 ELSE 0 END) as NotEmpNum 
		from np_dt_door_inout door 
		LEFT JOIN np_cd_card card on door.CARD_ID = card.ID 
		LEFT JOIN np_sys_person person on person.ID = card.PERSON_ID
		where door.OPEN_TIME >=#{startDate} AND door.OPEN_TIME<#{endDate} AND door.CONTROLUNITID in (select MANAGE_ID from NP_CF_SUBSYSTEM sub LEFT JOIN NP_EQ_AREA area on sub.AREA_ID = area.ID where area.AREA_CLASS='BROUGH' and area.FULL_PATH like CONCAT((select distinct FULL_PATH from NP_EQ_AREA where AREA_NAME = #{name}),'%' ))
		GROUP BY door.OPEN_TIME,door.CARD_ID,person.WORK_TYPE;
	]]>
  </select>
</mapper>