<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jd.pims.pem.dao.LabourOndutyDao" >
  <!-- 在岗人数  -->
  <resultMap id="labourOnduty" type="com.jd.pims.pem.model.LabourOnduty" >
    <id column="id" property="id" />
    <result column="cu_id" property="cuId"  />
    <result column="biz_date" property="bizDate"  />
    <result column="timing" property="timing"  />
    <result column="person_type" property="personType"  />
    <result column="quantity_onduty" property="quantityOnduty"  />
    <result column="create_time" property="createTime"  />
    <result column="last_update_time" property="lastUpdateTime"  />
  </resultMap>
  
  <resultMap id="labourOndutyDayState" type="com.jd.pims.pem.model.LabourOndutyDayState" >
    <id column="id" property="id" />
    <result column="cu_id" property="cuId"  />
    <result column="biz_date" property="bizDate"  />
    <result column="person_type" property="personType"  />
    <result column="avg_quantity" property="avgQuantity"  />
    <result column="max_quantity" property="maxQuantity"  />
    <result column="min_quantity" property="minQuantity"  />
    <result column="create_time" property="createTime"  />
    <result column="last_update_time" property="lastUpdateTime"  />
  </resultMap>

  <select id="getCurrentTimeLabourOnduty" resultMap="labourOnduty">
  	SELECT RS.BIZ_DATE,RS.PERSON_TYPE,sum(RS.QUANTITY_ONDUTY) QUANTITY_ONDUTY from 
		(SELECT LO.BIZ_DATE,LO.PERSON_TYPE,LO.QUANTITY_ONDUTY
		  	FROM JD_LE_LABOUR_ONDUTY LO
		  	LEFT JOIN NP_SYS_CONTROLUNIT CU ON LO.CU_ID=CU.ID
		  	WHERE LO.BIZ_DATE=#{currentDate}
		  		and CU.FULL_PATH like CONCAT(#{fullPath},'%' )
		  	ORDER BY TIMING DESC
		  	LIMIT 0,5
		) RS GROUP BY RS.BIZ_DATE,RS.PERSON_TYPE
  </select>

  <select id="getHistoryLabourOnduty" resultMap="labourOndutyDayState">
  	<![CDATA[
  	SELECT ST.ID, ST.CU_ID, ST.BIZ_DATE, ST.PERSON_TYPE, ST.AVG_QUANTITY, ST.MIN_QUANTITY, ST.MAX_QUANTITY
	FROM  JD_LE_LABOUR_ONDUTY_DAY_ST ST
	INNER JOIN NP_SYS_CONTROLUNIT CU ON ST.CU_ID=CU.ID
	WHERE BIZ_DATE>=#{startDate} AND BIZ_DATE<=#{endDate} 
		AND CU.FULL_PATH LIKE CONCAT(#{fullPath},'%' )

  	]]>
  </select>

  <select id="getCurrentTimeLabourOndutyForChart" resultType="java.util.HashMap">
	<![CDATA[	
		SELECT sum(case when LO.PERSON_TYPE='1' THEN LO.QUANTITY_ONDUTY ELSE 0 END) as EmpNum,sum(case when LO.PERSON_TYPE!='1' THEN LO.QUANTITY_ONDUTY ELSE 0 END) as NotEmpNum
		  	FROM JD_LE_LABOUR_ONDUTY LO
		  	LEFT JOIN NP_SYS_CONTROLUNIT CU ON LO.CU_ID=CU.ID
		  	WHERE LO.BIZ_DATE=#{currentDate}
		  		and CU.FULL_PATH like CONCAT((select FULL_PATH from NP_SYS_CONTROLUNIT where id in(select CONTROLUNITID from NP_EQ_AREA where id = #{id})),'%' )
		 GROUP BY LO.CU_ID
	]]>
  </select>
  
  <select id="getHistoryLabourOndutyForChart" resultType="java.util.HashMap">
	<![CDATA[	
		SELECT concat((date_format(LO.BIZ_DATE,'%d')),'日') as name,sum(case when LO.PERSON_TYPE='1' THEN LO.AVG_QUANTITY ELSE 0 END) as EmpNum,sum(case when LO.PERSON_TYPE!='1' THEN LO.AVG_QUANTITY ELSE 0 END) as NotEmpNum
		  	FROM JD_LE_LABOUR_ONDUTY_DAY_ST LO
		  	LEFT JOIN NP_SYS_CONTROLUNIT CU ON LO.CU_ID=CU.ID
		  	WHERE LO.BIZ_DATE>=#{startDate} AND LO.BIZ_DATE<#{endDate}
		  		and CU.FULL_PATH like CONCAT((select FULL_PATH from NP_SYS_CONTROLUNIT where id in(select CONTROLUNITID from NP_EQ_AREA where id = #{id})),'%' )
		 GROUP BY LO.BIZ_DATE
	]]>
  </select>
  
</mapper>