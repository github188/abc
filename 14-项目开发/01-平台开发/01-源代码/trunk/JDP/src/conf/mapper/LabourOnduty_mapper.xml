<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jd.pims.pem.dao.LabourOndutyDao" >
  <!-- 在岗人数  -->
  <resultMap id="labourOnduty" type="com.jd.pims.pem.model.LabourOnduty" >
    <id column="id" property="id" />
    <result column="cu_id" property="cuId"  />
    <result column="biz_date" property="bizDate"  />
    <result column="timing" property="timing"  />
    <result column="person_type" property="personType"  />
    <result column="quantity_onduty" property="quantityOnduty"  />
    <result column="create_time" property="createTime"  />
    <result column="last_update_time" property="lastUpdateTime"  />
  </resultMap>
  
  <resultMap id="labourOndutyDayState" type="com.jd.pims.pem.model.LabourOndutyDayState" >
    <id column="id" property="id" />
    <result column="cu_id" property="cuId"  />
    <result column="biz_date" property="bizDate"  />
    <result column="person_type" property="personType"  />
    <result column="avg_quantity" property="avgQuantity"  />
    <result column="max_quantity" property="maxQuantity"  />
    <result column="min_quantity" property="minQuantity"  />
    <result column="create_time" property="createTime"  />
    <result column="last_update_time" property="lastUpdateTime"  />
  </resultMap>

  <select id="getCurrentTimeLabourOnduty" resultMap="labourOnduty">
  	SELECT RS.BIZ_DATE,RS.PERSON_TYPE,sum(RS.QUANTITY_ONDUTY) QUANTITY_ONDUTY from 
		(SELECT LO.BIZ_DATE,LO.PERSON_TYPE,LO.QUANTITY_ONDUTY
		  	FROM JD_LE_LABOUR_ONDUTY LO
		  	LEFT JOIN NP_SYS_CONTROLUNIT CU ON LO.CU_ID=CU.ID
		  	WHERE LO.BIZ_DATE=#{currentDate}
		  		and CU.FULL_PATH like CONCAT(#{fullPath},'%' )
		  	ORDER BY TIMING DESC
		  	LIMIT 0,5
		) RS GROUP BY RS.BIZ_DATE,RS.PERSON_TYPE
  </select>

  <select id="getHistoryLabourOnduty" resultMap="labourOndutyDayState">
  	<![CDATA[
  	SELECT ST.ID, ST.CU_ID, ST.BIZ_DATE, ST.PERSON_TYPE, ST.AVG_QUANTITY, ST.MIN_QUANTITY, ST.MAX_QUANTITY
	FROM  JD_LE_LABOUR_ONDUTY_DAY_ST ST
	INNER JOIN NP_SYS_CONTROLUNIT CU ON ST.CU_ID=CU.ID
	WHERE BIZ_DATE>=#{startDate} AND BIZ_DATE<=#{endDate} 
		AND CU.FULL_PATH LIKE CONCAT(#{fullPath},'%' )
  	]]>
  </select>

  <select id="getCurrentTimeLabourOndutyForChart" resultType="java.util.HashMap">
	<![CDATA[	
		SELECT AREA.AREA_NAME as name,
		AREA.COORD1_X as x,
		AREA.COORD1_Y as y,
		IFNULL(avg(case when LO.PERSON_TYPE='1' THEN LO.QUANTITY_ONDUTY END),0) as EmpNum,
		IFNULL(avg(case when LO.PERSON_TYPE='2' THEN LO.QUANTITY_ONDUTY
 				 when LO.PERSON_TYPE='3' THEN LO.QUANTITY_ONDUTY
                 when LO.PERSON_TYPE='4' THEN LO.QUANTITY_ONDUTY END),0) as NotEmpNum,
        IFNULL(avg(case when LO.PERSON_TYPE='5' THEN LO.QUANTITY_ONDUTY END),0) as otherNumEmp
		  	FROM  NP_EQ_AREA AREA 
		  	LEFT JOIN NP_CF_SUBSYSTEM SUB ON SUB.AREA_ID = AREA.ID
		  	LEFT JOIN (
				select PERSON_TYPE,QUANTITY_ONDUTY,CU_ID from JD_LE_LABOUR_ONDUTY WHERE BIZ_DATE=#{currentDate} AND TIMING >=#{begin} AND TIMING <=#{end} 
			) LO  ON LO.CU_ID = SUB.MANAGE_ID
		  	WHERE  AREA.AREA_CLASS='BROUGH' and AREA.FULL_PATH like CONCAT((select FULL_PATH from NP_EQ_AREA where AREA_NAME = #{name}),'%' )
		 GROUP BY AREA.AREA_NAME,AREA.COORD1_X,AREA.COORD1_Y
	]]>
  </select>

  
  <select id="getHistoryLabourOndutyForChart" resultType="java.util.HashMap">
	<![CDATA[	
		SELECT concat(concat((date_format(LO.BIZ_DATE,'%m')),'月'),concat((date_format(LO.BIZ_DATE,'%d')),'日')) as name,sum(case when LO.PERSON_TYPE='1' THEN LO.AVG_QUANTITY ELSE 0 END) as EmpNum,sum(case when LO.PERSON_TYPE='2' THEN LO.AVG_QUANTITY
 				 when LO.PERSON_TYPE='3' THEN LO.AVG_QUANTITY
                 when LO.PERSON_TYPE='4' THEN LO.AVG_QUANTITY ELSE 0 END) as NotEmpNum
		  	FROM JD_LE_LABOUR_ONDUTY_DAY_ST LO
		  	WHERE LO.BIZ_DATE>=#{startDate} AND LO.BIZ_DATE<#{endDate}
			AND LO.CU_ID in(select MANAGE_ID from NP_CF_SUBSYSTEM sub LEFT JOIN NP_EQ_AREA area on sub.AREA_ID = area.ID where area.FULL_PATH like CONCAT((select FULL_PATH from NP_EQ_AREA where AREA_NAME = #{name}),'%' ))
		 GROUP BY LO.BIZ_DATE
	]]>
  </select>
  
</mapper>