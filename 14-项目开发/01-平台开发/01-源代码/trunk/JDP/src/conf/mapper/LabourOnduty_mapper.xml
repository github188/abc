<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jd.pims.pem.dao.LabourOndutyDao" >
  <!-- 在岗人数  -->
  <resultMap id="labourOnduty" type="com.jd.pims.pem.model.LabourOnduty" >
    <id column="id" property="id" />
    <result column="cu_id" property="cuId"  />
    <result column="biz_date" property="bizDate"  />
    <result column="timing" property="timing"  />
    <result column="person_type" property="personType"  />
    <result column="quantity_onduty" property="quantityOnduty"  />
    <result column="create_time" property="createTime"  />
    <result column="last_update_time" property="lastUpdateTime"  />
  </resultMap>
  
  <resultMap id="labourOndutyDayState" type="com.jd.pims.pem.model.LabourOndutyDayState" >
    <id column="id" property="id" />
    <result column="cu_id" property="cuId"  />
    <result column="biz_date" property="bizDate"  />
    <result column="person_type" property="personType"  />
    <result column="avg_quantity" property="avgQuantity"  />
    <result column="max_quantity" property="maxQuantity"  />
    <result column="min_quantity" property="minQuantity"  />
    <result column="create_time" property="createTime"  />
    <result column="last_update_time" property="lastUpdateTime"  />
  </resultMap>

  <select id="getCurrentTimeLabourOnduty" resultMap="labourOnduty">
   <![CDATA[
    SELECT DD.CU_ID,DD.PERSON_TYPE,MAX(DD.QUANTITY_ONDUTY) AS QUANTITY_ONDUTY FROM 	
  		(SELECT LO.CU_ID,LO.PERSON_TYPE,IFNULL(LO.QUANTITY_ONDUTY,0) AS QUANTITY_ONDUTY
		 FROM JD_LE_LABOUR_ONDUTY LO
		 	LEFT JOIN NP_SYS_CONTROLUNIT CU ON LO.CU_ID=CU.ID
		 WHERE LO.BIZ_DATE=#{currentDate} AND TIMING>=#{beginTime} AND TIMING<#{endTime}
		  		and CU.FULL_PATH like CONCAT(#{fullPath},'%' )
	    ) DD
    GROUP BY DD.CU_ID,DD.PERSON_TYPE
	ORDER BY DD.CU_ID ASC,DD.PERSON_TYPE ASC
	]]>	
  </select>

  <select id="getHistoryLabourOnduty" resultMap="labourOndutyState">
  	<![CDATA[
  	select dd.controlunitid as cu_id,CU.name as cu_name,dd.open_time as day_time,
		sum(case when dd.WORK_TYPE='1' THEN 1 ELSE 0 END) as num_emp,
		sum(case when dd.WORK_TYPE='2' THEN 1
		 		 when dd.WORK_TYPE='3' THEN 1
		         when dd.WORK_TYPE='4' THEN 1 ELSE 0 END) as num_temp,
	    sum(case when dd.WORK_TYPE='5' then 1 else 0 end) as num_other
	from (
		select DISTINCT card.controlunitid,date_format(door.OPEN_TIME,'%y-%m-%d') open_time,wtp.work_type,door.card_id
		  from np_dt_door_inout door 
			LEFT JOIN np_cd_card card on  card.ID =door.CARD_ID
			LEFT JOIN np_sys_person person on person.ID = card.PERSON_ID
	    LEFT JOIN (select person_code,work_type from np_sys_person p LEFT JOIN np_cd_card c on p.id=c.PERSON_ID and c.PERSON_ID is null) wtp on person.PERSON_CODE=wtp.person_code
	    LEFT JOIN np_sys_controlunit cu on cu.id=card.controlunitid
			where door.OPEN_TIME >=#{startDate} AND door.OPEN_TIME<=#{endDate} and door.card_id is not null
				and CU.FULL_PATH like CONCAT(#{fullPath},'%' )
	   group by card.controlunitid,open_time,wtp.work_type,door.card_id
	) dd
	LEFT JOIN np_sys_controlunit cu on CU.id =dd.controlunitid
	group by dd.controlunitid,dd.open_time
  	]]>
  </select>
  
  <select id="getCurrentTimeLabourOndutyForChart" resultType="java.util.HashMap">
	<![CDATA[	
		select 		
			IFNULL(round(avg(case when PERSON_TYPE='1' THEN QUANTITY_ONDUTY END),2),0) as EmpNum,
			IFNULL(round(avg(case when PERSON_TYPE='2' THEN QUANTITY_ONDUTY END),2),0)*0.8+
	 		IFNULL(round(avg(case	when PERSON_TYPE='3' THEN QUANTITY_ONDUTY END),2),0)*0.5+
	        IFNULL(round(avg(case	when PERSON_TYPE='4' THEN QUANTITY_ONDUTY END),2),0)*0.8 as NotEmpNum,
	        IFNULL(round(avg(case when PERSON_TYPE='5' THEN QUANTITY_ONDUTY END),2),0) as otherNumEmp
	        from JD_LE_LABOUR_ONDUTY 
	        WHERE BIZ_DATE=#{currentDate} 
	        AND TIMING >=#{begin} 
	        AND TIMING <#{end} 
			AND  CU_ID in(select MANAGE_ID from NP_CF_SUBSYSTEM sub LEFT JOIN NP_EQ_AREA area on sub.AREA_ID = area.ID where area.AREA_CLASS='BROUGH' and area.FULL_PATH like CONCAT((select distinct FULL_PATH from NP_EQ_AREA where AREA_NAME = #{name}),'%' ))
	]]>
  </select>
  
   <select id="getCurrentTimeLabourOndutyForChart1" resultType="java.util.HashMap">
	<![CDATA[	
		select 		
	        PERSON_TYPE as personType,IFNULL(QUANTITY_ONDUTY,0) as Num
	        from JD_LE_LABOUR_ONDUTY 
	        WHERE BIZ_DATE=#{currentDate} 
	        AND TIMING >=#{begin} 
	        AND TIMING <#{end} 
			AND  CU_ID in(select MANAGE_ID from NP_CF_SUBSYSTEM sub LEFT JOIN NP_EQ_AREA area on sub.AREA_ID = area.ID where area.AREA_CLASS='BROUGH' and area.FULL_PATH like CONCAT((select distinct FULL_PATH from NP_EQ_AREA where AREA_NAME = #{name}),'%' ))
	]]>
  </select>
  
<!--   <select id="getHistoryLabourOndutyForChart" resultType="java.util.HashMap">
	<![CDATA[	
		SELECT concat(concat((date_format(LO.BIZ_DATE,'%m')),'月'),concat((date_format(LO.BIZ_DATE,'%d')),'日')) as name,sum(case when LO.PERSON_TYPE='1' THEN LO.AVG_QUANTITY ELSE 0 END) as EmpNum,sum(case when LO.PERSON_TYPE='2' THEN LO.AVG_QUANTITY
 				 when LO.PERSON_TYPE='3' THEN LO.AVG_QUANTITY
                 when LO.PERSON_TYPE='4' THEN LO.AVG_QUANTITY ELSE 0 END) as NotEmpNum
		  	FROM JD_LE_LABOUR_ONDUTY_DAY_ST LO
		  	WHERE LO.BIZ_DATE>=#{startDate} AND LO.BIZ_DATE<#{endDate}
			AND LO.CU_ID in(select MANAGE_ID from NP_CF_SUBSYSTEM sub LEFT JOIN NP_EQ_AREA area on sub.AREA_ID = area.ID where area.AREA_CLASS='BROUGH' and area.FULL_PATH like CONCAT((select distinct FULL_PATH from NP_EQ_AREA where AREA_NAME = #{name}),'%' ))
		 GROUP BY LO.BIZ_DATE
	]]>
  </select> -->
  
    <select id="getHistoryLabourOndutyForChart" resultType="java.util.HashMap">
	<![CDATA[	
		select concat(concat((date_format(dd.OPEN_TIME,'%m')),'月'),concat((date_format(dd.OPEN_TIME,'%d')),'日')) as name,
		sum(case when dd.WORK_TYPE='1' THEN 1 ELSE 0 END) as EmpNum,
		sum(case when dd.WORK_TYPE='2' THEN 1
		 		 when dd.WORK_TYPE='3' THEN 1
		         when dd.WORK_TYPE='4' THEN 1 ELSE 0 END) as NotEmpNum
		from (
			select DISTINCT date_format(door.OPEN_TIME,'%y-%m-%d') open_time,wtp.work_type,door.card_id
			  from np_dt_door_inout door 
				LEFT JOIN np_cd_card card on  card.ID =door.CARD_ID
				LEFT JOIN np_sys_person person on person.ID = card.PERSON_ID
		    LEFT JOIN (select person_code,work_type from np_sys_person p LEFT JOIN np_cd_card c on p.id=c.PERSON_ID and c.PERSON_ID is null) wtp on person.PERSON_CODE=wtp.person_code
		    LEFT JOIN (select sub.id from NP_CF_SUBSYSTEM sub LEFT JOIN NP_EQ_AREA area on sub.AREA_ID = area.ID where area.AREA_CLASS='BROUGH' and area.FULL_PATH like CONCAT((select distinct FULL_PATH from NP_EQ_AREA where AREA_NAME = #{name}),'%' )) sub
					on sub.id=door.subsystem_id
				where door.OPEN_TIME >=#{startDate} AND door.OPEN_TIME<#{endDate} and door.card_id is not null
		   group by open_time,wtp.work_type,door.card_id
		) dd
		group by dd.open_time
	]]>
  </select>
</mapper>